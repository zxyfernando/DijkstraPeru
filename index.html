<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeruGrafo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        header {
            background-color: #3f51b5;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        header h1 {
            margin: 0;
            font-weight: 700;
        }
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
        }
        .controls button {
            background-color: #3f51b5;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            margin: 0 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
        }
        .controls button:hover {
            background-color: #303f9f;
        }
        .controls button i {
            margin-right: 0.5rem;
        }
        #map {
            height: 70vh;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .inputs {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .inputs label {
            margin: 0 0.5rem;
            font-weight: 700;
        }
        .inputs input {
            margin: 0 0.5rem;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .inputs button {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .inputs button:hover {
            background-color: #388e3c;
        }
        #path-info {
            text-align: center;
            margin: 1rem;
            font-weight: 700;
        }
        .controls button:nth-child(3) { /* Seleccionar el tercer botón */
            background-color: #9c27b0; /* Color morado */
        }
        .controls button:nth-child(3):hover {
            background-color: #6a0080; /* Color morado más oscuro al pasar el mouse */
        }
        .controls button:nth-child(4) { /* Seleccionar el cuarto botón */
        background-color: #ff9800; /* Color naranja */
        }
        .controls button:nth-child(4):hover {
            background-color: #f57c00; /* Color naranja más oscuro al pasar el mouse */
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&callback=initMap" async defer></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let map;
        let markers = [];
        let addNodeMode = false;
        let addEdgeMode = false;
        let selectedMarker = null;
        let pathLines = [];
        let lines = [];
        let weights = []; // Array para almacenar los pesos de las aristas

        //Funciones para botones

        function toggleWeights() {
            for (let line of lines) {
                if (line.weightLabel) {
                    line.weightLabel.close();
                    line.weightLabel.setMap(null);
                    line.weightLabel = null;
                } else {
                    const path = line.getPath();
                    const midPointIndex = Math.floor(path.getLength() / 2);
                    const midPoint = path.getAt(midPointIndex);

                    line.weightLabel = new google.maps.InfoWindow({
                        content: line.weight.toString(),
                        position: midPoint,
                        disableAutoPan: true,
                    });

                    // Agregar eventos mouseover y mouseout a la línea, no a la ventana
                    line.addListener('mouseover', function() {
                        if (this.weightLabel) { // Verificar si la ventana existe antes de abrirla
                            this.weightLabel.open(map);
                        }
                    });

                    line.addListener('mouseout', function() {
                        if (this.weightLabel) { // Verificar si la ventana existe antes de cerrarla
                            this.weightLabel.close();
                        }
                    });
                }
            }

            // Cambiar el ícono del botón (mismo código que antes)
            const icon = document.querySelector('.controls button:nth-child(4) i');
            icon.classList.toggle('fa-balance-scale');
            icon.classList.toggle('fa-balance-scale-right');
        }


        function getLineCenter(line) {
            const path = line.getPath();
            const midPointIndex = Math.floor(path.getLength() / 2);
            return path.getAt(midPointIndex);
        }

        function toggleEdges() {
            for (let line of lines) {
                line.setMap(line.getMap() ? null : map);
            }

            const icon = document.querySelector('.controls button:nth-child(3) i');
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        }

        //Logica

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: {lat: -12.0464, lng: -77.0428}  // Coordenadas de Cercado de Lima
            });

            google.maps.event.addListener(map, 'click', function(event) {
                if (addNodeMode) {
                    placeMarker(event.latLng);
                }
            });
        }

        function toggleAddNodeMode() {
            addNodeMode = !addNodeMode;
            addEdgeMode = false;
            selectedMarker = null;
            updateStatus();
        }

        function toggleAddEdgeMode() {
            addEdgeMode = !addEdgeMode;
            addNodeMode = false;
            selectedMarker = null;
            updateStatus();
        }

        function updateStatus() {
            document.getElementById('status').innerText = addNodeMode ? 'Modo: Añadir Nodo' : addEdgeMode ? 'Modo: Añadir Arista' : 'Modo: Navegación';
        }

        function placeMarker(location) {
            const lat = location.lat();
            const lng = location.lng();

            // Validación de coordenadas (mismo código que antes)
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert("Coordenadas inválidas. Por favor, haga clic en una ubicación válida en el mapa.");
                return;
            }

            const marker = new google.maps.Marker({
                position: location,
                map: map
            });

            fetch('/add_node', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ lat: lat, lng: lng }),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                const newIndex = parseInt(data.node_id); // Obtener el índice correcto del servidor
                marker.setTitle(newIndex.toString());
                marker.addListener('click', () => selectMarker(marker));
                markers.push(marker);
            });
        }

        function selectMarker(marker) {
            if (addEdgeMode) {
                if (selectedMarker) {
                    const node1 = selectedMarker.getTitle();
                    const node2 = marker.getTitle();
                    const weight = parseFloat(prompt("Ingrese el peso de la arista:")); // Convertir a número

                    // Validación del peso
                    if (isNaN(weight) || weight <= 0) {
                        alert("Peso inválido. Por favor, ingrese un número positivo.");
                        return;
                    }

                    addEdge(node1, node2, weight);
                    weights.push(weight); // Almacenar el peso
                    selectedMarker = null;
                } else {
                    selectedMarker = marker;
                }
            }
        }

        function addEdge(node1, node2, weight) {
            fetch('/add_edge', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ node1: node1, node2: node2, weight: weight }),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                const node1Index = markers.findIndex(m => m.getTitle() === node1); // Encontrar el índice del marcador 1
                const node2Index = markers.findIndex(m => m.getTitle() === node2); // Encontrar el índice del marcador 2
                drawEdge(node1Index, node2Index, weight); // Usar los índices correctos
            });
        }

        function drawEdge(node1Index, node2Index, weight) {
            const marker1 = markers[node1Index];
            const marker2 = markers[node2Index];

            // Validación de marcadores
            if (!marker1 || !marker2) {
                alert("Error al dibujar la arista: marcadores no encontrados.");
                return;
            }

            const edgeLine = new google.maps.Polyline({
                path: [marker1.getPosition(), marker2.getPosition()],
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2
            });
            edgeLine.setMap(map);
            // Asignar el peso a la línea en lugar de agregarlo al array weights
            edgeLine.weight = weight;
            lines.push(edgeLine);
        }

        function getShortestPath(start, end) {
            const startIndex = parseInt(start); // Convertir a entero
            const endIndex = parseInt(end); // Convertir a entero

            console.log("Índices enviados al servidor:", startIndex, endIndex); // Verificar los índices
            fetch('/shortest_path', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ start: startIndex, end: endIndex }),
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => { throw new Error(data.error); });
                }
                return response.json();
            })
            .then(data => {
                console.log(data.path);
                drawPath(data.path);
                displayPath(data.path);
            })
            .catch(error => {
                console.error('Error al obtener la ruta más corta:', error);
                document.getElementById('path-info').innerHTML = error.message;
            });
        }

        function drawPath(path) {
            // Remove previous path lines
            pathLines.forEach(line => line.setMap(null));
            pathLines = [];

            // Asegurarse de que los marcadores están cargados antes de dibujar la ruta
            if (markers.length === 0) {
                console.error('Error al dibujar la ruta: no hay marcadores en el mapa.');
                document.getElementById('path-info').innerHTML = 'Error al dibujar la ruta: no hay marcadores en el mapa.';
                return;
            }

            const coordinates = [];
            for (let i = 0; i < path.length - 1; i++) {
                const marker1 = markers.find(m => m.getTitle() === path[i].toString()); // Convertir a string
                const marker2 = markers.find(m => m.getTitle() === path[i + 1].toString()); // Convertir a string

                // Verificar si los marcadores existen antes de usarlos
                if (!marker1 || !marker2) {
                    console.error('Error al dibujar la ruta: marcadores no encontrados.', path[i], path[i + 1]);
                    document.getElementById('path-info').innerHTML = 'Error al dibujar la ruta: marcadores no encontrados.';
                    return;
                }

                coordinates.push(marker1.getPosition());
                coordinates.push(marker2.getPosition());

                const pathLine = new google.maps.Polyline({
                    path: [marker1.getPosition(), marker2.getPosition()],
                    geodesic: true,
                    strokeColor: '#0000FF',
                    strokeOpacity: 0.4,
                    strokeWeight: 8
                });
                pathLine.setMap(map);
                pathLines.push(pathLine);
            }
        }

        function displayPath(path) {
            const pathInfo = document.getElementById('path-info');
            pathInfo.innerHTML = ''; // Limpiar el contenido anterior

            if (path.length === 0) {
                pathInfo.innerHTML = 'No se encontró una ruta.';
                return;
            }

            const fetchPromises = [];
            let totalWeight = 0; // Variable para acumular el peso total

            for (let i = 0; i < path.length - 1; i++) {
                const node1 = path[i];
                const node2 = path[i + 1];

                const fetchPromise = fetch('/get_edge_weight', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ node1: node1, node2: node2 }),
                })
                .then(response => response.json())
                .then(data => {
                    const weight = data.weight;
                    totalWeight += weight; // Sumar el peso al total
                    return `${node1} --- ${weight} ---> ${node2}<br>`; // Formatear la información
                });

                fetchPromises.push(fetchPromise);
            }

            Promise.all(fetchPromises)
                .then(pathSegments => {
                    pathInfo.innerHTML = `La ruta mínima es: <br>${pathSegments.join('')}<br>La suma de las aristas es: ${totalWeight}`; // Mostrar la ruta y el peso total
                })
                .catch(error => {
                    console.error('Error al obtener los pesos de las aristas:', error);
                    pathInfo.innerHTML = 'Error al obtener los pesos de las aristas.';
                });
        }

        function exportGraph() {
            const fileContent = [];

            // Exportar nodos (coordenadas)
            for (let i = 0; i < markers.length; i++) {
                const pos = markers[i].getPosition();
                fileContent.push(`${pos.lat()} ${pos.lng()}`);
            }

            // Exportar aristas (índices de nodos y pesos)
            for (let i = 0; i < lines.length; i++) {
                const path = lines[i].getPath();
                const node1 = markers.findIndex(m => m.getPosition().equals(path.getAt(0)));
                const node2 = markers.findIndex(m => m.getPosition().equals(path.getAt(1)));
                fileContent.push(`${node1} ${node2} ${weights[i]}`); // Solo el peso, sin elementos adicionales
            }

            const blob = new Blob([fileContent.join('\n')], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'grafo.txt';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function clearMap() {
            // Eliminar marcadores
            for (let marker of markers) {
                marker.setMap(null);
            }
            markers = [];

            // Eliminar líneas
            for (let line of lines) {
                line.setMap(null);
            }
            lines = [];
        }

        function updateMap(graph) {
            clearMap(); // Limpiar el mapa
            markers = [];  // Resetear el array de marcadores
            lines = [];  // Resetear el array de líneas

            // Agregar nodos
            for (let node in graph.nodes) {
                const pos = graph.nodes[node].pos;
                const marker = new google.maps.Marker({
                    position: { lat: pos[0], lng: pos[1] },
                    map: map,
                    title: node
                });
                marker.addListener('click', () => selectMarker(marker));
                markers.push(marker);
            }

            // Agregar líneas y asignar pesos
            for (let edge of graph.edges) {
                const node1 = graph.nodes[edge[0]].pos;
                const node2 = graph.nodes[edge[1]].pos;
                const weight = edge[2]; // Obtener el peso de la arista

                const line = new google.maps.Polyline({
                    path: [
                        { lat: node1[0], lng: node1[1] },
                        { lat: node2[0], lng: node2[1] }
                    ],
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 3,
                    map: map
                });

                line.weight = weight; // Asignar el peso a la línea
                lines.push(line);
            }

            toggleEdges(); // Mostrar las aristas inicialmente (opcional)
        }

        $(document).ready(function() {
            initMap();

            $('#uploadForm').on('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                $.ajax({
                    url: '/import_graph',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        try {
                            if (response.success) {
                                updateMap(response.graph); // Actualizar el mapa con el grafo importado
                            } else {
                                alert('Error al importar el grafo: ' + response.error);
                            }
                        } catch (error) {
                            alert('Error al importar el grafo: ' + error.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error en la petición AJAX: ' + error); // Mostrar error de AJAX
                    }
                });
            });
        });
    </script>
</head>
<body onload="initMap()">
    <header>
        <h1>Ruta Minima de Recojo en Lima</h1>
    </header>
    <div class="controls">
        <button onclick="toggleAddNodeMode()"><i class="fas fa-map-marker-alt"></i> Añadir Nodo</button>
        <button onclick="toggleAddEdgeMode()"><i class="fas fa-route"></i> Añadir Arista</button>
        <button onclick="toggleEdges()"><i class="fas fa-eye-slash"></i> Mostrar/Ocultar Aristas</button>
        <button onclick="toggleWeights()"><i class="fas fa-balance-scale"></i> Mostrar/Ocultar Pesos</button>
        <button onclick="exportGraph()"><i class="fas fa-file-export"></i> Exportar Grafo</button>
        <span id="status">Modo: Navegación</span>
    </div>
    <div id="map"></div>
    <div class="inputs">
        <label for="start">Inicio:</label>
        <input type="text" id="start">
        <label for="end">Fin:</label>
        <input type="text" id="end">
        <button onclick="getShortestPath(document.getElementById('start').value, document.getElementById('end').value)">Calcular Ruta Más Corta</button>
    </div>
    <div id="path-info"></div>

    <!-- Formulario para subir el archivo -->
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="file" id="fileInput" accept=".txt">
        <button type="submit">Importar Grafo</button>
    </form>
</body>
</html>
